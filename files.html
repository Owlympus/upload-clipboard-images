<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div style="height: 300px; border: 1px solid black;" id="canvas_list">
    
    </div>

    <button id="btn-send" disabled><i>truc</i> Envoyer</button>

    <form action="files_post.php" method="post" enctype="multipart/form-data">
        <fieldset>
            <label for="field_1">Champ 1</label>
            <input type="text" id="field_1" name="field_1">
        </fieldset>
        <fieldset>
            <label for="field_2">Champ 2</label>
            <input type="text" id="field_2" name="field_2">
        </fieldset>
        <fieldset>
            <label for="field_3">Champ 3</label>
            <input type="text" id="field_3" name="field_3">
        </fieldset>
        <fieldset>
            <label for="field_4">Fichier </label>
            <input type="file" id="field_4" name="field_4">
        </fieldset>

        <button>Valider</button>
    </form>

    <script>
        let files = [];

        function watchButton() {
            let btn = document.getElementById('btn-send');
            if(files.length){
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        window.addEventListener("paste", e => {
            if (!e.clipboardData) return;
    
            let items = e.clipboardData.items;
    
            if (!items) return;
    
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    let canvas = document.createElement("canvas");
                    let ctx = canvas.getContext('2d');
                    let img = new Image();

                    img.onload = function(){
                        canvas.height = 150;
                        canvas.width = 150;

                        let scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                        // get the top left position of the image
                        let x = (canvas.width / 2) - (img.width / 2) * scale;
                        let y = (canvas.height / 2) - (img.height / 2) * scale;
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

                        document.getElementById('canvas_list').append(canvas);
                    };

                    let imgBlob = items[i].getAsFile();

                    // Crossbrowser support for URL
                    let URLObj = window.URL || window.webkitURL;

                    // Creates a DOMString containing a URL representing the object given in the parameter
                    img.src = URLObj.createObjectURL(imgBlob);

                    files.push(imgBlob);
                    watchButton();
                } else if (items[i].type.indexOf("text") !== -1) {
                    console.log(e.clipboardData.getData(items[i].type));
                    items[i].getAsString(e => {console.log(e)})
                }
            }

            console.log(files);
        });

        document.getElementById('btn-send').addEventListener('click', e => {
            console.log(e);
            console.log(e.currentTarget);

            let formData = new FormData();
            for(let i=0; i < files.length; i++){
                console.log(files[i]);
                formData.append('file[]', files[i]);
            }

            console.log(formData);

            fetch("files_post.php", {
                    body: formData,
                    method: "post"
            }).then(res => {
                console.log(res);
                return res.toString();
            }).then(res => {
                console.log(res);
            });
        })
    </script>
</body>
</html>

